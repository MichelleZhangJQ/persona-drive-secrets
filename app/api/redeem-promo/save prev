// app/api/redeem-promo/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
  // Added 'source' to the destructuring
  const { promoCode, itemKey, source } = await request.json();
  const supabase = createRouteHandlerClient({ cookies });
  
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  try {
    // 1. RULE: Only one 'promo' type unlock allowed per lifetime
    const { data: existingPromo } = await supabase
      .from('user_entitlements')
      .select('id')
      .eq('user_id', user.id)
      .eq('granted_via', 'promo')
      .maybeSingle();

    if (existingPromo) {
      return NextResponse.json(
        { error: "Limit reached: Only one free promo unlock is permitted per account." }, 
        { status: 400 }
      );
    }

    // 2. Validate the code exists and is active
    const { data: codeData, error: codeError } = await supabase
      .from('promo_codes')
      .select('*')
      .eq('code', promoCode)
      .eq('is_active', true)
      .single();

    if (codeError || !codeData) {
      return NextResponse.json({ error: "Invalid or expired promotion code." }, { status: 400 });
    }

    // --- NEW: TRANSACTIONAL UPDATES FOR ATTRIBUTION ---

    // 3. Insert the entitlement
    const { error: insertError } = await supabase
      .from('user_entitlements')
      .insert({
        user_id: user.id,
        item_key: itemKey,
        granted_via: 'promo',
        status: 'active'
      });

    if (insertError) throw insertError;

    // 4. Log the specific redemption for marketing analytics
    await supabase
      .from('promo_redemptions')
      .insert({
        user_id: user.id,
        code_used: promoCode,
        source_platform: source || 'direct' 
      });

    // 5. Increment the usage count on the promo code itself
    await supabase.rpc('increment_promo_usage', { code_param: promoCode });

    return NextResponse.json({ success: true });

  } catch (err) {
    return NextResponse.json({ error: "Server error during redemption." }, { status: 500 });
  }
}